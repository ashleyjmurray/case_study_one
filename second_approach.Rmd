---
title: "second approach"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#library(R2jags)
library(dynsurv)
library(survival)
library(R2jags)
library(tidyverse)
library(lubridate)
```

```{r}
leaders_data <- get(load("Leaders.RData"))

leaders_data$Censored <- as.factor(leaders_data$Censored)
leaders_data$Type <- as.factor(leaders_data$Type)
leaders_data$Age.Event <- as.numeric(leaders_data$Age.Event)
summary(leaders_data)
```

# Boxplot of age (Age.Event) by Type
```{r}
ggplot(data = leaders_data) +
  geom_boxplot(aes(x = Type, y = Age.Event))

ggplot(data = leaders_data) +
  geom_point(aes(x = Birth.Date, y = Age.Event))
```

# THIS IS OUR MODEL
$$
T_i \sim Weibull(\alpha, \mu) \\
log(\mu) = \beta_0 + \beta_1x_{i1}+\beta_2x_{i2}+...+\beta_px_{ip}\\
$$
Log of mu is done so that the mu parameter is always positive (the support on mu in Weibull is that mu > 0)

# More specificically
## WILL ADD INTERACTION LATER
$$
T_i \sim Weibull(\alpha, \mu_i) \\
\log(\mu_i) = \beta_0+\beta_1 \text{(Year of Birth_i)}+\beta_2 \text{(Leadership_i = UsPres)} + \beta_3\text{(Leadership_i = ChinaEmp)} \\
+ \beta_4\text{(Leadership_i = DalaiLama)} +\beta_5\text{(Leadership_i = JapanEmp)} \\
+ \beta_6\text{} 
$$


# Data Cleaning
```{r}
leaders_data <- leaders_data %>%
  mutate(TypeChinaEmp = as.factor(case_when(Type == "ChinaEmp" ~ 1,
                             TRUE ~ 0)),
         TypeDalaiLama = as.factor(case_when(Type == "DalaiLama" ~ 1,
                                   TRUE ~ 0)),
         TypeJapanEmp = as.factor(case_when(Type == "JapanEmp" ~ 1, 
                                  TRUE ~ 0)),
         TypePope = as.factor(case_when(Type == "Pope" ~ 1, 
                              TRUE ~ 0)),
         TypeUsPres = as.factor(case_when(Type == "UsPres" ~ 1,
                                TRUE ~ 0)))

leaders_nopred <- leaders_data %>%
  filter(!(Name %in% c("14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)", "Barack Obama", "Francis")))

leaders_nopred$Birth.Year <- year(leaders_nopred$Birth.Date)

survival_raw <- leaders_nopred$Age.Event
n <- length(survival_raw)

censored <- leaders_nopred$Censored
survival <- ifelse(censored == 0, survival_raw, NA)

censoring_limits <- ifelse(censored == 0, 120, survival_raw)
x_1 <- leaders_nopred$Birth.Year - mean(leaders_nopred$Birth.Year)
x_2 <- leaders_nopred$TypeUsPres
x_3 <- leaders_nopred$TypeChinaEmp
x_4 <- leaders_nopred$TypeDalaiLama
x_5 <- leaders_nopred$TypeJapanEmp
# add interaction b/w Birth.Year and Type
x_6 <- leaders_nopred$Birth.Year*as.numeric(leaders_nopred$TypeUsPres) 
x_7 <- leaders_nopred$Birth.Year*as.numeric(leaders_nopred$TypeChinaEmp)
x_8 <- leaders_nopred$Birth.Year*as.numeric(leaders_nopred$TypeDalaiLama)
x_9 <- leaders_nopred$Birth.Year*as.numeric(leaders_nopred$TypeJapanEmp)
```


```{r}
second_approach <- function() {
  for(i in 1:n_censored) {
    z_censored[i] ~ dpois(phi_censored[i])
    phi_censored[i] <- mu_censored[i] * pow(t_censored[i], r)
    mu_censored[i] <- exp(beta_censored[i])
    beta_censored[i] <- beta_0 + beta_1*x_1_censored[i] + beta_2*x_2_censored[i] + beta_3*x_3_censored[i] + beta_4*x_4_censored[i] + beta_5*x_5_censored[i]
  }
  
  for(j in 1:n_non_censored) { #total rows - 7 ** 7 are censored, rest are not censored
    survival_non_censored[j] ~ dweib(r, mu[j])
    mu[j] <- exp(beta[j])
    beta[j] <- beta_0 + beta_1*x_1_non_censored[j] + beta_2*x_2_non_censored[j] + beta_3*x_3_non_censored[j] + beta_4*x_4_non_censored[j] + beta_5*x_5_non_censored[j]
  }
  
  beta_0 ~ dnorm(0.0, 1.0E-4) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, 1.0E-4) # Prior on beta_1 is normal with low precision
  beta_2 ~ dnorm(0.0, 1.0E-4) # Prior on beta_2 is normal with low precision
  beta_3 ~ dnorm(0.0, 1.0E-4) # Prior on beta_1 is normal with low precision
  beta_4 ~ dnorm(0.0, 1.0E-4) # Prior on beta_2 is normal with low precision
  beta_5 ~ dnorm(0.0, 1.0E-4) # Prior on beta_2 is normal with low precision
  r ~ dexp(1) # Prior on r
}
```


```{r}
censored_dex = which(censored==1) # index of ppl who are censored

z_censored <- rep(0, length(censored_dex))
t_censored <- censoring_limits[censored_dex]
x_1_censored <- x_1[censored_dex] 
x_2_censored <- x_2[censored_dex] 
x_3_censored <- x_3[censored_dex]
x_4_censored <- x_4[censored_dex]
x_5_censored <- x_5[censored_dex]
#
n_censored <- length(censored_dex)
#

survival_non_censored <- survival[-censored_dex] # Remove ALL ALIVE PEOPLE
x_1_non_censored <- x_1[-censored_dex]
x_2_non_censored <- x_2[-censored_dex]
x_3_non_censored <- x_3[-censored_dex]
x_4_non_censored <- x_4[-censored_dex]
x_5_non_censored <- x_5[-censored_dex]
#
n_non_censored <- length(survival_non_censored)
#
data_Popes_second_approach <- list("n_censored",
                                   "n_non_censored",
                                   "z_censored",
                                   "t_censored",
                                   "x_1_censored",
                                   "x_2_censored",
                                   "x_3_censored",
                                   "x_4_censored",
                                   "x_5_censored",
                                   "survival_non_censored",
                                   "x_1_non_censored",
                                   "x_2_non_censored",
                                   "x_3_non_censored",
                                   "x_4_non_censored",
                                   "x_5_non_censored")
#
Bayesian_Popes_second_approach <- jags(data = data_Popes_second_approach,  
                                      parameters.to.save = c("beta_0",
                                                             "beta_1",
                                                             "beta_2", "beta_3", "beta_4", "beta_5",
                                                             "r"), 
                                      n.iter = 50000, 
                                      n.chains = 3,
                                      model.file = second_approach)
#
Bayesian_Popes_second_approach
```